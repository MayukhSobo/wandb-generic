name: Auto Version Bump and Release

on:
  workflow_run:
    workflows: ["Comprehensive Framework Tests"]
    types:
      - completed

jobs:
  auto-version-and-release:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # Fetch full history for proper versioning
    
    - name: Configure git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install bump2version
    
    - name: Get current version
      id: current_version
      run: |
        VERSION=$(python -c "import wandb_generic; print(wandb_generic.__version__)")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
    
    - name: Get latest commit message
      id: commit_info
      run: |
        COMMIT_MSG=$(git log -1 --pretty=format:%s)
        echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT
    
    - name: Determine version bump type
      id: bump_type
      run: |
        COMMIT_MSG="${{ steps.commit_info.outputs.message }}"
        
        if [[ $COMMIT_MSG == *"BREAKING CHANGE"* ]] || [[ $COMMIT_MSG == *"feat!"* ]]; then
          echo "bump=major" >> $GITHUB_OUTPUT
          echo "ğŸš¨ Major version bump (breaking changes detected)"
        elif [[ $COMMIT_MSG == feat* ]] || [[ $COMMIT_MSG == *"feat("* ]]; then
          echo "bump=minor" >> $GITHUB_OUTPUT  
          echo "âœ¨ Minor version bump (new features)"
        elif [[ $COMMIT_MSG == fix* ]] || [[ $COMMIT_MSG == *"fix("* ]] || [[ $COMMIT_MSG == *"bug"* ]]; then
          echo "bump=patch" >> $GITHUB_OUTPUT
          echo "ğŸ› Patch version bump (bug fixes)"
        else
          echo "bump=patch" >> $GITHUB_OUTPUT
          echo "ğŸ”§ Patch version bump (other changes)"
        fi
    
    - name: Create .bumpversion.cfg
      run: |
        cat > .bumpversion.cfg << EOF
        [bumpversion]
        current_version = ${{ steps.current_version.outputs.version }}
        commit = True
        tag = False
        
        [bumpversion:file:pyproject.toml]
        search = version = "{current_version}"
        replace = version = "{new_version}"
        
        [bumpversion:file:src/wandb_generic/__init__.py]
        search = __version__ = "{current_version}"
        replace = __version__ = "{new_version}"
        EOF
    
    - name: Bump version
      run: |
        bump2version ${{ steps.bump_type.outputs.bump }} --verbose
    
    - name: Get new version
      id: get_version
      run: |
        NEW_VERSION=$(python -c "import wandb_generic; print(wandb_generic.__version__)")
        echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$NEW_VERSION" >> $GITHUB_OUTPUT
    
    - name: Push version bump
      run: |
        git push origin main
    
    - name: Check if release exists
      id: check_release
      run: |
        if git rev-parse "v${{ steps.get_version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi
    
    - name: Get latest commits since last release
      id: get_commits
      if: steps.check_release.outputs.exists == 'false'
      run: |
        # Get the last release tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LAST_TAG" ]; then
          # No previous tags, get all commits
          COMMITS=$(git log --pretty=format:"- %s" --no-merges)
        else
          # Get commits since last tag
          COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"- %s" --no-merges)
        fi
        
                 # Generate release notes
         cat << EOF > release_notes.md
         # ğŸš€ wandb-generic v${{ steps.get_version.outputs.version }}
         
         ## âœ¨ What's New
         
         **Version bump:** ${{ steps.current_version.outputs.version }} â†’ ${{ steps.get_version.outputs.version }} (${{ steps.bump_type.outputs.bump }})
         
         **Latest commit:** ${{ steps.commit_info.outputs.message }}
         
         ### Recent Changes
         $COMMITS
        
        ## ğŸ¯ Framework Support
        
        This release supports:
        - âœ… **PyTorch** - Full tensor and model support
        - âœ… **TensorFlow/Keras** - Sequential and functional API
        - âœ… **scikit-learn** - All estimators and pipelines  
        - âœ… **Financial Analysis** - Portfolio tracking, metrics
        - âœ… **Physics Simulations** - Scientific computing
        - âœ… **Data Processing** - ETL pipelines and batch processing
        - âœ… **Optimization** - Any optimization algorithms
        - âœ… **A/B Testing** - Statistical analysis workflows
        - âœ… **Generic Functions** - ANY Python function!
        
        ## ğŸ“¦ Installation
        
        \`\`\`bash
        pip install wandb-generic==${{ steps.get_version.outputs.version }}
        \`\`\`
        
        ## ğŸ”— Links
        
        - ğŸ“– [Documentation](https://github.com/MayukhSobo/wandb-generic#readme)  
        - ğŸ› [Issues](https://github.com/MayukhSobo/wandb-generic/issues)
        - ğŸ’¬ [Discussions](https://github.com/MayukhSobo/wandb-generic/discussions)
        
        ---
        
        **Full Changelog**: https://github.com/MayukhSobo/wandb-generic/compare/${LAST_TAG}...v${{ steps.get_version.outputs.version }}
        EOF
    
    - name: Create Release
      if: steps.check_release.outputs.exists == 'false'
      run: |
        gh release create ${{ steps.get_version.outputs.tag }} \
          --title "Release ${{ steps.get_version.outputs.tag }}" \
          --notes-file release_notes.md \
          --latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Release Summary
      if: steps.check_release.outputs.exists == 'false'
      run: |
        echo "ğŸ‰ Created release ${{ steps.get_version.outputs.tag }}"
        echo "ğŸ“¦ PyPI publish will trigger automatically"
        echo "ğŸš€ Users can install with: pip install wandb-generic==${{ steps.get_version.outputs.version }}"
    
    - name: Skip Release (Already Exists)
      if: steps.check_release.outputs.exists == 'true'
      run: |
        echo "â„¹ï¸ Release ${{ steps.get_version.outputs.tag }} already exists"
        echo "ğŸ’¡ Update version in pyproject.toml and src/wandb_generic/__init__.py to create new release" 